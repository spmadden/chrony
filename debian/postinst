#!/bin/sh
# postinst script for chrony
#
# see: dh_installdeb(1)

. /usr/share/debconf/confmodule
set -e


# targets: configure|abort-upgrade|abort-remove|abort-deconfigure

ucf_managed_sources="true"
case "$1" in
    configure|reconfigure)

        adduser --system \
                --group \
                --quiet \
                --comment "Chrony daemon" \
                --home /var/lib/chrony \
                --no-create-home _chrony

        ubuntu_ntp_pools_sources_filepath="/etc/chrony/sources.d/ubuntu-ntp-pools.sources"
        packaged_ubuntu_ntp_pools_sources_filepath="/usr/share/chrony/ubuntu-ntp-pools.sources"

        db_get chrony/configure_ubuntu_pools_in_sourcesd
        ucf_managed_sources="${RET}"

        if command -v ucf >/dev/null
        then
            ucf --debconf-ok --three-way /usr/share/chrony/chrony.conf /etc/chrony/chrony.conf
            ucf --debconf-ok --three-way /usr/share/chrony/chrony.keys /etc/chrony/chrony.keys
            if [ "${ucf_managed_sources}" = "true" ]; then
                ucf --debconf-ok --three-way "${packaged_ubuntu_ntp_pools_sources_filepath}" "${ubuntu_ntp_pools_sources_filepath}"
            else
                # If this was under ucf before, purge it.
                # If it wasn't under ucf before, this does not fail
                ucf --debconf-ok --purge "${ubuntu_ntp_pools_sources_filepath}"
                rm -f "${ubuntu_ntp_pools_sources_filepath}"
            fi
            if [ -x "$(command -v ucfr)" ]; then
                ucfr chrony /etc/chrony/chrony.conf
                ucfr chrony /etc/chrony/chrony.keys
                if [ "${ucf_managed_sources}" = "true" ]; then
                    ucfr chrony "${ubuntu_ntp_pools_sources_filepath}"
                else
                    # If this was under ucf before, purge it.
                    # If it wasn't under ucf before, this does not fail
                    ucfr --purge chrony "${ubuntu_ntp_pools_sources_filepath}"
                fi
            fi
        fi

        # Change the user and group ownership of "/var/l{ib,og}/chrony" iif
        # chronyd's configuration does not contain the "user" directive.
        # Also, update these directories' mode bits to 0750 to follow upstream.
        #
        # We must also ensure that chronyd can read /etc/chrony/chrony.keys
        # after dropping root privileges.
        if ! chronyd -p | grep -q "^user"; then
            for d in /var/lib/chrony /var/log/chrony /etc/chrony/chrony.keys; do
                if ! dpkg-statoverride --list "$d" >/dev/null; then
                    if [ "$d" = "/etc/chrony/chrony.keys" ]; then
                        dpkg-statoverride --update --add root _chrony 0640 "$d"
                    else
                        dpkg-statoverride --update --add _chrony _chrony 0750 "$d"
                    fi
                fi
            done
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
