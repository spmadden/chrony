__no_system_clock_control() {
    if ! dpkg-vendor --derives-from Ubuntu; then
        sed -i '/^DAEMON_OPTS=/s/"\(.*\)"/"\1 -x"/' /etc/default/chrony
        mkdir -p /etc/systemd/system/chrony.service.d
        cat <<EOF > /etc/systemd/system/chrony.service.d/override.conf
[Unit]
ConditionCapability=
EOF
        systemctl daemon-reload && systemctl --quiet restart chrony.service
    fi
}

__test_fail() {
    printf 'FAIL\n' >&2
    return 1
}

__test_ok() {
    printf 'OK\n'
    return 0
}

__test_skip() {
    [ -n "$1" ] && printf 'SKIP: (%s)\n' "$1" || printf 'SKIP\n'
    exit 77
}

# Ubuntu's default config is fully populated causing issues with the test
# If any of those tests run on Ubuntu, clear some and restart the daemon
# to pick this up before entering the tests.
if grep -q "^pool.*ubuntu.pool.ntp.org" /etc/chrony/chrony.conf; then
    sudo sed -i -e '/^pool.*ubuntu.pool.ntp.org/d' /etc/chrony/chrony.conf
    restart_chronyd
fi
